<!DOCTYPE html>
<html lang="es-MX">
  <head>
    <meta name="robots" content="noindex" />
    <meta name="googlebot" content="noindex" />
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="profile" href="https://gmpg.org/xfn/11" />
    <meta
      name="description"
      content="App Diseñada para Generar Tickets y Ordenes."
    />
    <meta name="author" content="Gabriel Mendez" />
    <title>Renew | GabrielLMDev</title>
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="https://firebasestorage.googleapis.com/v0/b/gabriellm-34067.appspot.com/o/favicon.ico?alt=media&token=b6804d55-8b10-4292-bba1-4c75541a7c43"
    />
    <link rel="canonical" href="https://gabriellmdev.com/" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="App Ticket | GabrielLMDev" />
    <meta
      property="og:description"
      content="Generar ordenes y registrarlas en la base de datos."
    />
    <meta property="og:url" content="https://gabriellmdev.com/" />
    <meta property="og:site_name" content="GabrielLM" />
    <meta
      property="og:image"
      content="https://firebasestorage.googleapis.com/v0/b/gabriellm-34067.appspot.com/o/BannerOGMeta.png?alt=media&token=e74a1881-6c69-4237-bea6-6e987d18fb1a"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link href="src/css/global-styles.css?1.0" rel="stylesheet" />
    <link href="src/css/loader-style.css?1.0" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/8.1.0/mdb.min.css"
      integrity="sha512-viZnJCMu1IKCniSdlMH+5f8c7mOlAjqg53E3ycTycIGTk+20PCDuszNiWMYZ+g2Vwzu40Qp5JDPjpB+NHT0Jzw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.min.css"
    />
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.datatables.net/2.3.6/js/dataTables.min.js"></script>
  </head>
  <body>
    <div class="pb-3 px-5 invisible-scrollbar text-dark" id="accounts">
      <h2 class="text-center mt-3">Renovar Cuentas</h2>
      <div class="search-form table-responsive">
        <table class="table text-center" id="table_acc">
          <thead class="table-dark">
            <tr>
              <th scope="col">ID</th>
              <th scope="col">SERVICIO</th>
              <th scope="col">CORREO</th>
              <th scope="col">ESTATUS</th>
              <th scope="col">VENCE</th>
              <th scope="col">Funciones</th>
            </tr>
          </thead>
          <tbody id="productsTable"></tbody>
        </table>
      </div>
    </div>
    <script>
      const API_BASE = "https://main.gabriellmdev.com/api/resellers/stock_web/";
      /* const API_BASE = "http://localhost:3000/api/resellers/stock_web/"; */

      document.addEventListener("DOMContentLoaded", async () => {
        const apps = await getProducts();
        try {
          productsTable.innerHTML = "";
          apps.forEach((app) => {
            let Temp = firestoreTimestampToMillis(app.expiresAt);
            let Expires = timestampToDateMX(Temp);
            const tr = document.createElement("tr");
            tr.innerHTML = `
                      <td>${app.id}</td>
                      <td>${app.id_Service}</td>
                      <td>${app.mail}</td>
                      <td>${app.status}</td>
                      <td>${Expires}</td>
                      <td class="d-flex">
                          <button class="btn_Delete_App btn btn-danger mx-1 w-100"
                              id="${app.id}">RENOVAR</button>
                      </td>
                  `;
            productsTable.appendChild(tr);
          });
          productsTable.dataset.apps = JSON.stringify(apps);
          const table = document.getElementById("table_acc");
          if (table) {
            new DataTable(table, {
              // Configuración de la tabla
              paging: true, // Habilitar paginación
              searching: true, // Habilitar búsqueda
              ordering: true, // Habilitar ordenamiento
              responsive: true, // Habilitar modo responsivo
              order: [[4, "desc"]], // Ordenar por la segunda columna (Edad) de forma descendente
              pageLength: 10, // Definir el número de filas por página
              lengthMenu: [5, 10, 15, 20], // Opciones de cantidad de filas por página
              language: {
                url: "https://cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json", // Traducción al español
              },
            });
          }
        } catch (error) {
          console.error(error);
        }
      });

      const productsTable = document.getElementById("productsTable");
      productsTable.addEventListener("click", async (e) => {
        const apps = JSON.parse(productsTable.dataset.apps || "[]");

        if (e.target.classList.contains("btn_Delete_App")) {
          const buttonId = e.target.id;
          console.log(buttonId);
          const response = await renewAcc(buttonId);
          alert(response.message);
          if (response.status) {
            window.location.href = "renew.html";
          }
        }
      });

      async function getProducts() {
        try {
          const res = await fetch(API_BASE);
          const data = await res.json();
          if (!res.ok)
            throw new Error(data.error || "Error al obtener productos");
          return data.data;
        } catch (err) {
          throw err;
        }
      }

      function firestoreTimestampToMillis(ts) {
        if (ts == null) throw new Error("Missing timestamp");

        // Si ya es número (ms o s)
        if (typeof ts === "number") return ts < 1e12 ? ts * 1000 : ts;

        // Firestore Timestamp real (admin/web)
        if (typeof ts.toMillis === "function") return ts.toMillis();

        // Objeto plano tipo { _seconds, _nanoseconds } o { seconds, nanoseconds }
        const seconds = ts.seconds ?? ts._seconds;
        const nanos = ts.nanoseconds ?? ts._nanoseconds ?? 0;

        if (typeof seconds !== "number")
          throw new Error("Invalid Firestore timestamp object");

        return seconds * 1000 + Math.floor(nanos / 1e6);
      }

      const MX_TZ = "America/Mexico_City";
      function timestampToDateMX(timestamp) {
        const ts = Number(timestamp);
        if (!Number.isFinite(ts)) throw new Error("Timestamp inválido");

        const ms = ts < 1e12 ? ts * 1000 : ts; // acepta segundos o ms
        const date = new Date(ms);

        const parts = new Intl.DateTimeFormat("es-MX", {
          timeZone: MX_TZ,
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        }).formatToParts(date);

        const get = (t) => parts.find((p) => p.type === t)?.value;
        return `${get("day")}/${get("month")}/${get("year")}`;
      }

      async function renewAcc(id) {
        try {
          const res = await fetch(`${API_BASE}renew/${id}`, {
            method: "PATCH",
          });

          const result = await res.json();
          if (!res.ok)
            throw new Error(result.error || "Error al eliminar producto");
          return result;
        } catch (err) {
          throw err;
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mdb-ui-kit@9.1.0/js/mdb.umd.min.js"></script>
  </body>
</html>
